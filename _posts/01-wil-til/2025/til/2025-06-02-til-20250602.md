---
title: âœ¨TIL - ë°°ì¹˜ ì„±ëŠ¥ ìµœì í™”
author: ggggraceful
date: 2025-06-02
categories: [01.TIL/WIL, TIL]
tags: [TIL]
---

<br/>
<br/>



# ë°°ì¹˜ ì„±ëŠ¥ ìµœì í™”

ë””ë¹„ ë°ì´í„° ì •ë¦¬ ë°°ì¹˜ ì¤‘ ìœ ë… í•œ ë°°ì¹˜ë§Œ ëŠë¦¬ê²Œ ì‹¤í–‰ëœë‹¤.  
ë‹¤ë¥¸ ê¸°ì¡´ì— ì˜ ì‚¬ìš©í•˜ê³  ìˆë˜ ë°°ì¹˜ë¥¼ ê°€ì ¸ë‹¤ ë§Œë“  ê°™ì€ ì½”ë“œì˜€ì§€ë§Œ, ì—¬ëŸ¬ ë°°ì¹˜ê°€ ìˆëŠ”ë° í•´ë‹¹ ë°°ì¹˜ê°€ ë„ˆë¬´ ì˜¤ë˜ê±¸ë ¤ ë‹¤ë¥¸ ë°°ì¹˜ë“¤ì´ ë°€ë¦¬ê¸° ì‹œì‘í–ˆë‹¤.  

ì´ ë°°ì¹˜ê°€ ìì •ì— ì‹œì‘í•´ 4ì‹œê°„ ë°˜ ì†Œìš”ë˜ì–´ ìš´ì˜ ì‹œì‘ ì‹œê°„ì´ ì˜¤ì „ 5ì‹œ ì´í›„ì—ë„ ëë‚˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ì˜€ë‹¤.   
í…Œì´ë¸” ì •ë¦¬ ì‚­ì œë°°ì¹˜ê°€ ìš´ì˜ì¤‘ì—ë„ ëŒê¸° ì‹œì‘í•œ ê²ƒì´ë‹¤. ğŸ˜¨ ë‹¤í–‰ì´ë„ ìš´ì˜ë°ì´í„°ê°€ ë³µì‚¬ëœ ë°ì´í„°ë¼ ìš´ì˜ì—ëŠ” ë¬¸ì œê°€ ì—†ì—ˆë‹¤.  

ê¸°ì¡´ì—ëŠ” ë‹¤ë¥¸ ì‚­ì œ ë°°ì¹˜ ì½”ë“œë“¤ì—ë„ ì‚¬ìš©í•˜ê³  ìˆë˜ ë°©ì‹ì¸
`QuerydslZeroPagingItemReader` ë¡œ readí•˜ê³   
writer ì—ì„œ í˜¸ì¶œí•  ë©”ì„œë“œ ì„¤ì •í•´ `.methodName("delete")`  í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©í•˜ì˜€ë‹¤.  
ë‹¤ìŒì€ ì˜ˆì‹œ ì½”ë“œì´ë‹¤.  

~~~ java
  // ----- STEP --------------------------------------------------------------------------------------------------------------------
	// ë¡œê·¸ í…Œì´ë¸” ì‚­ì œ
  @Bean
  public Step logTableDeleteStep() {
    return sf.get(JOB_NAME_PREFIX + "LogTableDeleteStep")
        .<LogTable, LogTable>chunk(CHUNK_SIZE)
        .reader(logTableDeleteReader(null))
        .writer(logTableDeleteWriter())
        .transactionManager(new JpaTransactionManager(emf))
        .build();
  }

  // Reader
  @Bean
  @StepScope
  @SuppressWarnings("SpringElInspection")
  public QuerydslZeroPagingItemReader<LogTable> logTableDeleteReader(
      @Value("#{jobParameters[paramDelLog]}") String date) {
    return new QuerydslZeroPagingItemReader<>(emf, CHUNK_SIZE, jpaQueryFactory ->
        jpaQueryFactory.selectFrom(logTable)
            .where(logTable.date.loe(date))
    );
  }

  // Writer
  public RepositoryItemWriter<LogTable> logTableDeleteWriter() {
    return new RepositoryItemWriterBuilder<LogTable>()
        .repository(LogTableRepo).methodName("delete").build();
  }
~~~

ì½”ë“œëŠ” ê²°êµ­ ì½ì€ row ëª¨ë‘, ë°ì´í„° í•˜ë‚˜ë‹¹ ì¿¼ë¦¬ê°€ 1ë²ˆì”© ì‹¤í–‰í•˜ê²Œ ë˜ëŠ” ì½”ë“œì´ë‹¤.  

ê·¸ë˜ì„œ ì´ ìŠ¤íƒ­ì—ì„œë§Œ í•˜ë£¨ í‰ê·  9ë§Œê±´ì´ ì‚­ì œë˜ëŠ” ì¤‘ì´ì–´ì„œ 9ë§Œê°œì˜ delete ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœê²ƒì´ë‹¤.  

delete ì¿¼ë¦¬ ê°œìˆ˜ë¥¼ ì¤„ì´ëŠ” ê²ƒì´ ì„±ëŠ¥ì„ ìœ„í•´ ì¢‹ë‹¤ê³  íŒë‹¨í•˜ì˜€ë‹¤.  

chunk ì‚¬ì´ì¦ˆëŠ” 1000ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆì§€ë§Œ delete ì¿¼ë¦¬ ì‹¤í–‰ íšŸìˆ˜ë¥¼ ì¤„ì—¬ì¤„ ìˆ˜ëŠ” ì—†ë‹¤.  

---

# í•´ê²°1

> ë²Œí¬ ì‚­ì œ

ë¨¼ì € ë²Œí¬ ì‚­ì œë¥¼ ì‹œë„í•˜ì˜€ë‹¤.  

ë²Œí¬ ì‚­ì œëŠ” readerëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³  chunk size(1000) ë§Œí¼ ì½ì–´ inì ˆì— í•´ë‹¹ pkë¥¼ ë‹¤ ë„£ì–´ì£¼ê³ ,  

ê·¸ chunk ì‚¬ì´ì¦ˆë§Œí¼ í•œë²ˆì— delete ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ì´ë‹¤.  

inì ˆì— 1000ê°œ ì´ìƒì˜ ì¡°ê±´ì´ ë“¤ì–´ê°€ê²Œë˜ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí• ìˆ˜ ìˆìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ë‘ì—ˆë‹¤.  

```java
  // Writer
  @Bean
  @StepScope
  public ItemWriter<LogTable> logTableWriter() {
    return items -> {
      if (items.isEmpty()) return;
      
      EntityManager em = emf3.createEntityManager();
      EntityTransaction tx = em.getTransaction();
      
      try {
        tx.begin();
        
        // ID ëª©ë¡ ì¶”ì¶œ (ì˜ˆ: Long íƒ€ì… ê¸°ì¤€)
        List<Long> idList = items.stream()
                .map(LogTable::getId)
                .collect(Collectors.toList());
        
        // ë²Œí¬ ì‚­ì œ
        em.createQuery("DELETE FROM SC.LOG_TABLE l WHERE l.ID IN :ids")
                .setParameter("ids", idList)
                .executeUpdate();
        
        tx.commit();
      } catch (Exception e) {
        log.error("ì‚­ì œ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage(), e);
        throw e;
        // ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ ë¡¤ë°±í•  í•„ìš” ì—†ìŒ
      } finally {
        em.close();
      }
    };
  }
```

í•˜ë£¨ ì‹œë„ í•´ë´¤ì§€ë§Œ ì ˆë°˜ì •ë„ë°–ì— ì‹œê°„ì´ ì¤„ì§€ ì•Šì•˜ë‹¤..  

2ì‹œê°„ì •ë„ ê±¸ë ¸ë‹¤.  

---

# í•´ê²°2

> ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¡œ rownum(chunk_size) ë§Œí¼ì”© ì‚­ì œ

ì‚¬ì‹¤ ì´ë¯¸ í•„ìš”ì—†ëŠ” 2ë‹¬ ì „ ë°ì´í„°ë¼ ì‹¤íŒ¨í•´ë„ ë¡¤ë°±í•  í•„ìš”ë„ ì—†ì—ˆê³ , ë‹¤ë¥¸ ê¸°ë¡ì„ ë‚¨ê¹€ í•„ìš”ì—†ëŠ” í…Œì´ë¸”ì´ë¼ ì¢€ ë” ê°„ë‹¨í•˜ê²Œ ì‚­ì œí•´ë„ ë˜ì—ˆë‹¤.
inì ˆë¡œ ë‹¤ ë„£ì–´ì„œ ì‚­ì œí•˜ëŠ” ê²½ìš°ëŠ” ë³´í†µ ë¡¤ë°±ì„ ëŒ€ë¹„í•´ ì‚¬ìš©í•˜ëŠ”ë°, ì´ ê²½ìš°ì—ëŠ” êµ³ì´ ì‚­ì œí•œ ë°ì´í„°ë¥¼ ë¡¤ë°±í•  í•„ìš”ê°€ ì—†ì—ˆë‹¤.  

ì‚­ì œ ì¡°ê±´ì€ ì§€ì •í•œ íŒŒë¼ë¯¸í„°ë³´ë‹¤ ì´ì „ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ëŠ” ê²ƒì´ì–´ì„œ í•œêº¼ë²ˆì— ì‚­ì œí•´ë„ ë˜ê² ì§€ë§Œ~  
í˜¹ì‹œ ëª¨ë¥¼ ì›ì¸ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ë¬¸ì œë‚˜ í…Œì´ë¸”ë½ì„ ìš°ë ¤í•˜ì—¬ chunk ì‚¬ì´ì¦ˆë§Œí¼ì”© ì‚­ì œí•˜ê³ , ì‚­ì œ ì§„í–‰ë¥ ì„ ë¡œê·¸ì— ë‚¨ê¸°ê¸°ë¡œ í–ˆë‹¤.  

~~~java
 @Bean
public Step logTableDeleteStep() {
  return sf.get(JOB_NAME_PREFIX + "logTableDeleteStep")
    .<LogTable, LogTable>chunk(CHUNK_SIZE)
    .reader(new ListItemReader<>(Collections.singletonList(new LogTable()))) // ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•Šì§€ë§Œ readerê°€ ì—†ìœ¼ë©´ ì»´íŒŒì¼ ì—ëŸ¬ ë°œìƒ
    .writer(logTableDeleteWriter(null))
    .transactionManager(new JpaTransactionManager(emf3))
    .build();
}

// Writer
@Bean
@StepScope
public ItemWriter<LogTable> logTableDeleteWriter(@Value("#{jobParameters[paramDelLog]}") String date) {
  return items -> {
    EntityManager em = emf3.createEntityManager();

    try {
      // ì´ ê±´ìˆ˜ ì¡°íšŒ
      Number countResult = (Number) em.createNativeQuery("""
          SELECT COUNT(*) FROM SC.LOG_TABLE WHERE DATE < TO_DATE(?1, 'YYYYMMDD') """)
        .setParameter(1, paramDeptDt)
        .getSingleResult();

      long totalCount = countResult.longValue();
      long deletedTotal = 0;

      log.info("ì‚­ì œ ëŒ€ìƒ ì´ ê±´ìˆ˜: {}", totalCount);

      while (true) {
        EntityTransaction transaction = em.getTransaction();
        transaction.begin();

        int deletedCount = em.createNativeQuery("""
            DELETE FROM SC.LOG_TABLE WHERE DATE < TO_DATE(?1, 'YYYYMMDD') AND ROWNUM <= ?2 """)
          .setParameter(1, date)
          .setParameter(2, CHUNK_SIZE)
          .executeUpdate();
        transaction.commit();

        deletedTotal += deletedCount;

        log.info("ì‚­ì œ ì§„í–‰ë¥ : {}/{} ({}%)", deletedTotal, totalCount, String.format("%.2f", (deletedTotal * 100.0) / totalCount));

        if (deletedCount == 0) {
          log.info("ì‚­ì œ ì™„ë£Œ. ì´ {}ê±´ ì‚­ì œë¨.", deletedTotal);
          break;
        }
      }

    } catch (Exception e) {
      log.error("ì‚­ì œ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage(), e);
      // ë¡¤ë°±í•˜ì§€ ì•Šê³  ì˜ˆì™¸ë§Œ ë˜ì§
      throw e;
    } finally {
      em.close();
    }
  };
}
~~~

ì´ë ‡ê²Œ ìˆ˜ì •í•˜ì˜€ê³ , ê²°ê³¼ëŠ” 4ì‹œê°„ 30ë¶„ëŒ€ì—ì„œ ì—ì„œ â†’ 30ì´ˆëŒ€ë¡œ ì¤„ì–´ë“¤ì—ˆë‹¤!!  

ì‚­ì œ ì§„í–‰ë¥ ì„ í‘œì‹œí•˜ê¸° ìœ„í•´ ì „ì²´ ê±´ìˆ˜ë¥¼ í•œë²ˆ ì„¸ì£¼ê³ ,  
í•´ë‹¹ ì¡°ê±´ì˜ ë°ì´í„°ê°€ ì—†ì„ë•Œê¹Œì§€ ë°˜ë³µë¬¸ìœ¼ë¡œ chunk size ë§Œí¼ ì‚­ì œí•˜ëŠ” ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœë‹¤.
í•˜ë£¨ í‰ê·  9ë§Œê±´ì´ë¼ 90ë²ˆ ì‹¤í–‰ë˜ê¸°ëŠ” í•˜ì§€ë§Œ,
BATCH_STEP_EXECUTIONì—ì„œ í‘œì‹œë  count ë¥¼ ë‹¤ë¥¸ ë°°ì¹˜ë“¤ê³¼ì˜ í†µì¼ì„±ì„ ìœ„í•´ ê·¸ëŒ€ë¡œ 1000ìœ¼ë¡œ ë‘ì—ˆë‹¤.  

---

---


# ë‹¤ë¥¸ ë¬¸ì œ ë°œìƒ

> BATCH_STEP_EXECUTION ì— ì €ì¥ë˜ëŠ” READ_COUNT, WRITE_COUNT, COMMIT_COUNT ê±´ìˆ˜ ë¹„ì •ìƒ

ê·¸ë¦¬ê³  ì´ë ‡ê²Œ í–ˆì„ ë•Œ ë˜ ë¬¸ì œê°€ ë°°ì¹˜ ì „ìš©í…Œì´ë¸”ì— countê°€ ì œëŒ€ë¡œ ì…ë ¥ë˜ê³  ìˆì§€ ì•Šì•˜ë‹¤.
READ_COUNT, WRITE_COUNT ì—ëŠ” ë¬´ì¡°ê±´ chunk ì‚¬ì´ì¦ˆê°€ ì…ë ¥ë˜ê³  ìˆì—ˆê³ ,  
COMMIT_COUNTì—ëŠ” ë¬´ì¡°ê±´ 2ê°€ ë“¤ì–´ê°€ê³ ìˆì—ˆë‹¤.  

~~~ 
COMMIT_COUNT = 2
READ_COUNT = CHUNK_SIZE
WRITE_COUNT = CHUNK_SIZE
~~~

readerì™€ writerì„ ì œëŒ€ë¡œ ì‚¬ìš©í•˜ê³  ìˆì§€ ì•Šì•„ì„œ ì œëŒ€ë¡œ count ë  ìˆ˜ ì—†ì—ˆë‹¤.  
ì§ì ‘ ì…ë ¥í•˜ëŠ” ê²ƒìœ¼ë¡œ ìˆ˜ì •ì„ í•´ë³´ë‹ˆ  

~~~
COMMIT_COUNT = deleteì¿¼ë¦¬ íšŸìˆ˜ + 2
READ_COUNT = ì‚­ì œ ëŒ€ìƒ row + CHUNK_SIZE
WRITE_COUNT = ì‚­ì œ ëŒ€ìƒ row + CHUNK_SIZE
~~~

ì´ë ‡ê²Œ ë‚˜ì˜¤ê¸° ì‹œì‘í–ˆë‹¤..

ì¼ë‹¨ readerê°€ í•„ìš”ê°€ ì—†ì–´ ë”ë¯¸ë°ì´í„°ë¡œ ì¡°íšŒë˜ê²Œ ì„¤ì •ì„ í•´ì„œ  
readerì—ì„œ ë”ì´ìƒ ëŒ€ìƒì´ ì—†ì„ë•Œê¹Œì§€ chunkì‚¬ì´ì¦ˆ ë§Œí¼ ê³„ì† ì¡°íšŒë¥¼ ì‹œë„í–ˆê¸°ë•Œë¬¸ì—  
ë”ì´ìƒ ì‚­ì œëŒ€ìƒì´ ì—†ì„ ê²½ìš°ì—ë„ 1ë²ˆë” ì¡°íšŒí•´ì„œ CHUNK_SIZE ë§Œí¼ ë” countê°€ ë˜ëŠ” ìƒí™©ì´ì—ˆë‹¤.  
ê·¸ë¦¬ê³  ë” ì°¾ì•„ë³´ë‹ˆ ì´ëŸ°ê²½ìš°ì—ëŠ” êµ³ì´ reader, writerì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  tasklet ì„ ì‚¬ìš©í•´ ë” ê°„ë‹¨í•˜ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆì—ˆë‹¤!  

### ê¸°ì¡´ì½”ë“œ 

~~~java
  @Bean
  public Step logTableDeleteStep() {
    return sf.get(JOB_NAME_PREFIX + "LogTableDeleteStep")
            .<LogTable, LogTable>chunk(CHUNK_SIZE)
            .reader(logTableDeleteReader(null))
            .writer(logTableDeleteWriter())
            .transactionManager(new JpaTransactionManager(emf3))
            .build();
  }
~~~

### ë³€ê²½ì½”ë“œ

~~~java
  @Bean
  public Step logTableDeleteStep() {
    return sf.get(JOB_NAME_PREFIX + "LogTableDeleteStep")
            .tasklet(logTableDeleteTasklet(null))
            .transactionManager(new JpaTransactionManager(emf3))
            .build();
  }
~~~

ì˜ë¯¸ ì—†ëŠ” readerì„ ë¹¼ê³ , ê¸°ì¡´ wirterë¥¼ taskletìœ¼ë¡œ ë³€ê²½ë§Œ í•˜ë©´ëœë‹¤.
ì´ë ‡ê²Œ ë³€ê²½í•˜ì—¬ READ_COUNT , WRITE_COUNT  ëŠ” ì›í•˜ëŠ” ê°’ì´ ë“¤ì–´ê°€ê²Œ ë˜ì—ˆë‹¤.

```
COMMIT_COUNT = deleteì¿¼ë¦¬ íšŸìˆ˜ + 2
READ_COUNT = ì‚­ì œ ëŒ€ìƒ row ê±´ìˆ˜(ì •ìƒ)
WRITE_COUNT = ì‚­ì œ ëŒ€ìƒ row ê±´ìˆ˜(ì •ìƒ)
```

COMMIT_COUNTëŠ” Step ì‹œì‘ ì‹œ 1ë²ˆ, Tasklet ì™„ë£Œ ì‹œ 1ë²ˆì˜ íŠ¸ëœì­ì…˜ ì»¤ë°‹ì´ ë°œìƒí•´ commit_countì˜ ìˆ˜ê°€ í•­ìƒ +2ë˜ì–´ ë‚˜ì˜¤ê²Œ ë˜ëŠ” ê²ƒì´ì—ˆë‹¤.  

ê·¸ë˜ì„œ ì´ë¶„ì€ ê·¸ëƒ¥ ì¼ë‹¨ ì§ì ‘ -2 í•´ì£¼ëŠ” ì½”ë“œë¡œ ì„¤ì •í•˜ì˜€ë‹¤.  

```java
			
    StepExecution stepExecution = chunkContext.getStepContext().getStepExecution();
    stepExecution.setReadCount((int) deletedTotal);
    stepExecution.setWriteCount((int) deletedTotal);
    stepExecution.setCommitCount(commitCount - 2); //  Step ì‹œì‘ ì‹œ 1ë²ˆ, Tasklet ì™„ë£Œ ì‹œ 1ë²ˆì˜ íŠ¸ëœì­ì…˜ ì»¤ë°‹ì´ ë°œìƒí•´ commit_countì˜ ìˆ˜ê°€ í•­ìƒ +2ë˜ì–´ ë‚˜ì˜¨ë‹¤.

    StepExecution stepExecution = chunkContext.getStepContext().getStepExecution();
    stepExecution.setReadCount((int) deletedTotal);
      stepExecution.setWriteCount((int) deletedTotal);
      stepExecution.setCommitCount(commitCount - 2); //  Step ì‹œì‘ ì‹œ 1ë²ˆ, Tasklet ì™„ë£Œ ì‹œ 1ë²ˆì˜ íŠ¸ëœì­ì…˜ ì»¤ë°‹ì´ ë°œìƒí•´ commit_countì˜ ìˆ˜ê°€ í•­ìƒ +2ë˜ì–´ ë‚˜ì˜¨ë‹¤.

```

---

# ë¦¬íŒ©í† ë§

ì´ëŸ° ë¹„ìŠ·í•œ ë¡œê·¸ì„± í…Œì´ë¸” ì‚­ì œí•˜ëŠ” ì—¬ëŸ¬ ìŠ¤íƒ­ì—ì„œ ë™ì¼ ë¬¸ì œ ë°œìƒí•˜ì—¬, ë©”ì†Œë“œë¡œ ìƒì„±í•´ ì‚¬ìš©í•´ì•¼ í¸í•œê±° ê°™ì•˜ë‹¤.  
ì¼ë‹¨ í•„ìš”í•œ í˜•ì‹ìœ¼ë¡œ ë§Œë“¤ê¸´í–ˆëŠ”ë° ì© ë§ˆìŒì— ë“¤ì§„ ì•ŠëŠ”ë‹¹..  

ë‚ ì§œ ì¡°ê±´ìœ¼ë¡œ chunk_size ë§Œí¼ ì‚­ì œë˜ëŠ” Tasklet ë©”ì†Œë“œë¥¼ ìƒì„±í•˜ê³  êº¼ë‚´ì“°ê¸°ë¡œ í–ˆë‹¤.  
í•„ìš” íŒŒë¼ë¯¸í„°ëŠ” ê° ìŠ¤íƒ­ë§ˆë‹¤ ë””ë¹„ë‚˜ ìŠ¤í‚¤ë§ˆê°€ ë‹¬ë¼ ì§€ì • EntityManagerë¥¼ ë°›ê³ ,
ì‚­ì œ ì§„í–‰ë¥  í‘œì‹œì— ì‚¬ìš©ë  totalCountQuery,  
ì‚­ì œì‹œ ì‚¬ìš©í•  deleteQuery,
ê·¸ë¦¬ê³  ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©ë  ë‚ ì§œì™€, chunk_sizeê°€ í•„ìš”í•˜ë‹¤.  

```java
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.core.StepExecution;
import org.springframework.batch.core.step.tasklet.Tasklet;
import org.springframework.batch.repeat.RepeatStatus;

import javax.persistence.EntityManager;
import javax.persistence.EntityTransaction;
import java.text.DecimalFormat;

@Slf4j
public class CustomDeleteTasklet {
	
	/**
	 * ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì‚­ì œ Tasklet ìƒì„± ë©”ì†Œë“œ
	 *
	 * @param em          EntityManager (ì™¸ë¶€ ì£¼ì…)
	 * @param paramDate   ê¸°ì¤€ì¼ì (e.g. '20240601')
	 * @param countQuery  ì‚­ì œ ëŒ€ìƒ ê±´ìˆ˜ ì¡°íšŒ ì¿¼ë¦¬ (1ë²ˆ íŒŒë¼ë¯¸í„°ë¡œ ê¸°ì¤€ì¼ì ì‚¬ìš©)
	 * @param deleteQuery ì‹¤ì œ ì‚­ì œ ì¿¼ë¦¬ (1ë²ˆ íŒŒë¼ë¯¸í„°: ê¸°ì¤€ì¼ì, 2ë²ˆ íŒŒë¼ë¯¸í„°: chunkSize)
	 * @param chunkSize   1íšŒ ì‚­ì œ ì²˜ë¦¬ ê±´ìˆ˜
	 * @return Tasklet
	 */
	public Tasklet createDeleteTasklet(EntityManager em, String paramDate, String countQuery, String deleteQuery, int chunkSize) {
		return (contribution, chunkContext) -> {
			long deletedTotal = 0;
			long totalCount = 0;
			int commitCount = 0;
			
			try {
				Number countResult = (Number) em.createNativeQuery(countQuery)
						.setParameter(1, paramDate)
						.getSingleResult();
				
				totalCount = countResult.longValue();
				log.info("ì‚­ì œ ëŒ€ìƒ ì´ ê±´ìˆ˜: {}", formatNumber(totalCount));
				
				while (true) {
					EntityTransaction transaction = em.getTransaction();
					transaction.begin();
					
					int deletedCount = em.createNativeQuery(deleteQuery)
							.setParameter(1, paramDate)
							.setParameter(2, chunkSize)
							.executeUpdate();
					
					transaction.commit();
					deletedTotal += deletedCount;
					commitCount++;
					
					log.info("ì‚­ì œ ì§„í–‰ë¥ : {}/{} ({}%)", formatNumber(deletedTotal), formatNumber(totalCount),
							String.format("%.2f", (deletedTotal * 100.0) / totalCount));
					
					if (deletedCount == 0) {
						log.info("ì‚­ì œ ì™„ë£Œ. ì´ {}ê±´ ì‚­ì œë¨.", formatNumber(deletedTotal));
						break;
					}
				}
				
				StepExecution stepExecution = chunkContext.getStepContext().getStepExecution();
				stepExecution.setReadCount((int) deletedTotal);
				stepExecution.setWriteCount((int) deletedTotal);
				stepExecution.setCommitCount(commitCount - 2); //  Step ì‹œì‘ ì‹œ 1ë²ˆ, Tasklet ì™„ë£Œ ì‹œ 1ë²ˆì˜ íŠ¸ëœì­ì…˜ ì»¤ë°‹ì´ ë°œìƒí•´ commit_countì˜ ìˆ˜ê°€ í•­ìƒ +2ë˜ì–´ ë‚˜ì˜¨ë‹¤.
				
			} catch (Exception e) {
				log.error("ì‚­ì œ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage(), e);
				throw e;
			}
			
			return RepeatStatus.FINISHED;
		};
	}
	
	
	public static String formatNumber(Long number) {
		if (number == null) {
			return "0";
		}
		DecimalFormat fm = new DecimalFormat("#,###");
		return fm.format(number);
	}
}

```

ì¿¼ë¦¬ë¥¼ repositoryì—ì„œ ë¶ˆëŸ¬ì˜¤ê³ ì‹¶ì§€ë§Œ, ê²°ê³¼ê°€ ì•„ë‹Œ ì¿¼ë¦¬ìì²´ê°€ í•„ìš”í•œ ìƒí™©ì´ë¼ ë„¤ì´í‹°ë¸Œì¿¼ë¦¬ë¡œ ë°›ëŠ”ë‹¤.  

```java
  @Bean
  public Step logTableDeleteStep() {
    return sf.get(JOB_NAME_PREFIX + "LogTableDeleteStep")
            .tasklet(logTableDeleteTasklet(null))
            .transactionManager(new JpaTransactionManager(emf3))
            .build();
  }

  @Bean
  @StepScope
  public Tasklet logTableDeleteTasklet(@Value("#{jobParameters[paramDelLog]}") String date) {
    EntityManager em = emf.createEntityManager();
    
    String countQuery = """
        SELECT COUNT(*)
        FROM SC.LOG_TABLE
        WHERE DATE < TO_DATE(?1, 'YYYYMMDD')
    """;
    
    String deleteQuery = """
        DELETE FROM SC.LOG_TABLE
        WHERE DATE< TO_DATE(?1, 'YYYYMMDD')
        AND ROWNUM <= ?2
    """;
    
    CustomDeleteTasklet factory = new CustomDeleteTasklet();
    return factory.createDeleteTasklet(em, date, countQuery, deleteQuery, CHUNK_SIZE);
  }
```

ì´ëŸ°ì‹ìœ¼ë¡œ countQuery , deleteQuery  ì¿¼ë¦¬ë§Œ ë³€ê²½í•´ì£¼ë©´ ì‚¬ìš©ê°€ëŠ¥í•˜ë‹¤.
ê·¸ë¦¬ê³  ë‹¤ë¥¸ ë¡œê·¸ì„± í…Œì´ë¸” ì‚­ì œ ë°°ì¹˜ì—ë„ ì ìš©í•´ë³´ì•˜ë‹¤. ì—­ì‹œ íš¨ê³¼ëŠ” ì¢‹ì•˜ë‹¤ ã…ã…  
ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë„£ëŠ”ê±¸ ì¢€ë” ë³´ê¸° ì‰½ê²Œ ìˆ«ìê°€ ì•„ë‹Œê°’ìœ¼ë¡œ ë„£ì–´ì£¼ê³ ì‹¶ì—ˆì§€ë§Œâ€¦ ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤..ã…ã… ìˆ«ìê°€ ì œì¼ ì¢‹ì€ë°©ë²•ì´ë¼êµ¬â€¦  
ì¼ë‹¨ ì´ì •ë„ë¡œ ë§ˆë¬´ë¦¬í•´ë³¸ë‹¤.  

![ì´ë¯¸ì§€](https://github.com/user-attachments/assets/ea3a8280-f5d0-4cb4-bef4-26b9dd9d79ae)


---


